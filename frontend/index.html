<!-- ===================================================
   IMPAGINAZIONE DELLA WEB APP
   Progetto di Laurea - Calcolatore di Interessi
   Autore: [Alex Brambilla]
   Corso di Laurea in Informatica Per Le Aziende Digitali - A.A. 2024/2025
   ===================================================-->

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calcolatore di Interessi</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
.montante-grande {
    font-size: 3rem;
    font-weight: bold;
    color: #0074D9;
    text-align: center;
    margin-bottom: 25px;
    opacity: 0;
    transition: opacity 0.6s ease;
}
.fade-show {
    opacity: 1 !important;
    transform: scale(1) !important;
    transition: all 0.6s ease;
}
@keyframes fadeSlideIn {
    0% { opacity: 0; transform: translateY(-30px); }
    100% { opacity: 1; transform: translateY(0); }
}
.h1-show {
    opacity: 1;
    transform: translateY(0);
    animation: fadeSlideIn 1.5s ease forwards;
}
#nuovoCalcolo {
    display: block;
    margin: 25px auto 0 auto;
}
</style>
</head>
<body>

<div class="container fullscreen">
    <div class="card fade-show" id="formCard">
        <h1>Calcolatore di Interessi</h1>
        <form id="calcForm" class="form">
            <label>Versamento iniziale (€):</label>
            <input type="number" step="0.01" name="vers_iniziale" required>
            <label>Versamento periodico (€):</label>
            <input type="number" step="0.01" name="vers_periodico" required>
            <label>Durata (anni):</label>
            <input type="number" step="0.1" name="anni" required>
            <label>Tasso di interesse annuo (%):</label>
            <input type="number" step="0.01" name="interesse" required>
            <label>Tipo di interesse:</label>
            <select name="tipo" id="tipoInteresse" required>
                <option value="semplice">Semplice</option>
                <option value="composto" selected>Composto</option>
            </select>
            <div id="frequenzaContainer">
                <label>Frequenza dei versamenti:</label>
                <select name="frequenza">
                    <option value="annuale">Annuale</option>
                    <option value="trimestrale">Trimestrale</option>
                    <option value="mensile" selected>Mensile</option>
                </select>
            </div>
            <button type="submit">Calcola</button>
        </form>
    </div>

    <div class="card" id="resultsCard" style="display:none; opacity:0; transform: scale(0.9);">
        <h1>Risultati</h1>
        <div class="result animate" id="risultatiBox"></div>
        <canvas id="graficoRisparmio"></canvas>
        <button id="nuovoCalcolo">Nuovo calcolo</button>
    </div>
</div>

<script>
const calcForm = document.getElementById('calcForm');
const formCard = document.getElementById('formCard');
const resultsCard = document.getElementById('resultsCard');
const risultatiBox = document.getElementById('risultatiBox');
const nuovoBtn = document.getElementById('nuovoCalcolo');
const freqContainer = document.getElementById('frequenzaContainer');
let chart = null;

window.addEventListener('load', () => {
    const formTitle = document.querySelector('#formCard h1');
    if(formTitle) formTitle.classList.add('h1-show');
});

function formatta_euro(val) {
    return val.toLocaleString('it-IT', {minimumFractionDigits:2, maximumFractionDigits:2});
}

function animaPro(montante, interessi, versamenti, datiGrafico, chart, durata=2000){
    const steps = durata/16;
    let currentStep = 0;
    const anim = setInterval(()=>{
        currentStep++;
        const progress = currentStep/steps;
        document.getElementById('montanteTot').innerHTML = '€ ' + formatta_euro(montante*progress);
        document.getElementById('versamentiTot').innerHTML = '€ ' + formatta_euro(versamenti*progress);
        document.getElementById('interessiMat').innerHTML = '€ ' + formatta_euro(interessi*progress);
        if(chart && chart.data && chart.data.datasets[0]){
            chart.data.datasets[0].data = datiGrafico.map(v => v*progress);
            chart.update('none');
        }
        document.getElementById('montanteTot').style.opacity = progress;
        if(currentStep >= steps){
            clearInterval(anim);
            document.getElementById('montanteTot').innerHTML = '€ ' + formatta_euro(montante);
            document.getElementById('versamentiTot').innerHTML = '€ ' + formatta_euro(versamenti);
            document.getElementById('interessiMat').innerHTML = '€ ' + formatta_euro(interessi);
            document.getElementById('montanteTot').style.opacity = 1;
        }
    }, 16);
}

calcForm.addEventListener('submit', function(e){
    e.preventDefault();
    const data = new FormData(calcForm);
    const vers_iniziale = parseFloat(data.get('vers_iniziale'));
    const vers_periodico = parseFloat(data.get('vers_periodico'));
    const anni = parseFloat(data.get('anni'));
    const interesse = parseFloat(data.get('interesse'));
    const tipo = data.get('tipo');
    const frequenza_str = data.get('frequenza');
    const freqMap = {"annuale":1,"trimestrale":4,"mensile":12};
    const n = freqMap[frequenza_str] || 1;

    let versamentiTot = vers_iniziale + vers_periodico*n*anni;
    let montanteTot = 0;
    let interessi = 0;


if (tipo === "semplice") {
    const i = interesse / 100;
    const n_periodi = n;
    const m = n_periodi * anni;
    const capitale_totale = vers_iniziale + vers_periodico * m;

    // Modello lineare realistico: ogni versamento matura in media metà tempo
    const interessi_totali = capitale_totale * i * (anni / 2);
    montanteTot = capitale_totale + interessi_totali;
    interessi = interessi_totali; // ✅ aggiorna la variabile per la visualizzazione
} else {
    const i = interesse / 100;
    const n_periodi = n;
    const potenza = Math.pow(1 + i / n_periodi, n_periodi * anni);

    // Versamento iniziale capitalizzato
    const mont_iniz = vers_iniziale * potenza;

    // Piano di accumulo dei versamenti periodici
    const mont_per = vers_periodico * (potenza - 1) / (i / n_periodi);

    // Totale e interessi maturati
    montanteTot = mont_iniz + mont_per;
    interessi = montanteTot - versamentiTot;
}


    risultatiBox.innerHTML = `
        <p style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:5px; text-transform:uppercase;">CAPITALE FINALE</p>
        <p id="montanteTot" class="montante-grande">€ 0</p>
        <p><strong>Versamenti totali:</strong> <span id="versamentiTot">€ 0</span></p>
        <p><strong>Interessi maturati:</strong> <span id="interessiMat">€ 0</span></p>
    `;

    formCard.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    formCard.style.opacity = 0;
    formCard.style.transform = 'scale(0.9)';
    setTimeout(()=>{
        formCard.style.display = 'none';
        resultsCard.style.display = 'block';
        setTimeout(()=>{
            resultsCard.classList.add('fade-show');
            const resTitle = resultsCard.querySelector('h1');
            if(resTitle) resTitle.classList.add('h1-show');
        },50);
    },500);

    if(chart){ chart.destroy(); chart = null; }

    const ctx = document.getElementById('graficoRisparmio').getContext('2d');
    const labels = [];
    const datiGrafico = [];
    for(let anno=1; anno<=anni; anno++){
        let cap;
        if(tipo === "semplice"){
            const i = interesse / 100;
            const m = n * anno;
            const mont_iniz = vers_iniziale * (1 + i * anno);
            const mont_per = vers_periodico * m + vers_periodico * i * ((m - 1) / (2 * n));
            cap = mont_iniz + mont_per;
        } else {
            cap = vers_iniziale*Math.pow(1 + interesse/100/n, n*anno) + 
                  vers_periodico*((Math.pow(1 + interesse/100/n, n*anno)-1)/(interesse/100/n));
        }
        labels.push(`Anno ${anno}`);
        datiGrafico.push(cap);
    }

    let borderColor = tipo === 'composto' ? '#00c183' : '#0074D9';
    let backgroundColor = tipo === 'composto' ? 'rgba(0,193,131,0.2)' : 'rgba(0,116,217,0.2)';

    chart = new Chart(ctx, {
        type:'line',
        data:{ labels: labels, datasets:[{
            label:'Capitale accumulato (€)',
            data:datiGrafico.map(v=>0),
            borderColor:borderColor,
            backgroundColor:backgroundColor,
            fill:true,
            tension:0.3,
            pointRadius:5,
            pointHoverRadius:8,
            pointHoverBackgroundColor:'#00c183',
            pointHoverBorderColor:'#0074D9',
            pointHoverBorderWidth:3
        }]},
        options:{
            responsive:true,
            plugins:{ legend:{display:false} },
            scales:{ y:{ beginAtZero:true, ticks:{ callback: v=>'€ '+formatta_euro(v) } } }
        }
    });

    animaPro(montanteTot, interessi, versamentiTot, datiGrafico, chart, 2000);
});

nuovoBtn.addEventListener('click', function(){
    resultsCard.style.transition = 'opacity 0.5s ease, transform 0.5s ease';
    resultsCard.style.opacity = 0;
    resultsCard.style.transform = 'scale(0.9)';
    setTimeout(()=>{
        resultsCard.style.display = 'none';
        resultsCard.classList.remove('fade-show');
        formCard.style.display = 'block';
        formCard.style.opacity = 1;
        formCard.style.transform = 'scale(1)';
        calcForm.reset();
        freqContainer.style.display = 'block';
    },500);
});
</script>
</body>
</html>



