<!-- ===================================================
   IMPAGINAZIONE DELLA WEB APP
   Progetto di Laurea - Calcolatore di Interessi
   Autore: [Alex Brambilla]
   Corso di Laurea in Informatica Per Le Aziende Digitali - A.A. 2024/2025
   ===================================================-->

<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calcolatore di Interessi</title>
<link rel="stylesheet" href="/static/style.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>

.montante-grande {
    font-size: 3rem;
    font-weight: bold;
    color: #0074D9;
    text-align: center;
    margin-bottom: 25px;
    opacity: 0;
    transition: opacity 0.6s ease;
}
.fade-show {
    opacity: 1 !important;
    transform: scale(1) !important;
    transition: all 0.6s ease;
}
@keyframes fadeSlideIn {
    0% { opacity: 0; transform: translateY(-30px); }
    100% { opacity: 1; transform: translateY(0); }
}
.h1-show {
    opacity: 1;
    transform: translateY(0);
    animation: fadeSlideIn 1.5s ease forwards;
}
#nuovoCalcolo {
    display: block;
    margin: 25px auto 0 auto;
}
</style>
</head>
<body>

<div class="container fullscreen">
    <div class="card fade-show" id="formCard">
        <h1>Calcolatore di Interessi</h1>
        <form id="calcForm" class="form">
            <label>Versamento iniziale (€):</label>
            <input type="number" step="0.01" name="vers_iniziale" required>
            <label>Versamento periodico (€):</label>
            <input type="number" step="0.01" name="vers_periodico" required>
            <label>Durata (anni):</label>
            <input type="number" step="0.1" name="anni" required>
            <label>Tasso di interesse annuo (%):</label>
            <input type="number" step="0.01" name="interesse" required>
            <label>Tipo di interesse:</label>
            <select name="tipo" id="tipoInteresse" required>
                <option value="semplice">Semplice</option>
                <option value="composto" selected>Composto</option>
            </select>
            <div id="frequenzaContainer">
                <label>Frequenza dei versamenti:</label>
                <select name="frequenza">
                    <option value="annuale">Annuale</option>
                    <option value="trimestrale">Trimestrale</option>
                    <option value="mensile" selected>Mensile</option>
                </select>
            </div>
            <button type="submit">Calcola</button>
        </form>
    </div>

    <div class="card" id="resultsCard" style="display:none; opacity:0; transform: scale(0.9);">
        <h1>Risultati</h1>
        <div class="result animate" id="risultatiBox"></div>
        <canvas id="graficoRisparmio"></canvas>
        <button id="nuovoCalcolo">Nuovo calcolo</button>
    </div>
</div>

<script>
const formCalcolo = document.getElementById('calcForm');
const cardForm = document.getElementById('formCard');
const cardRisultati = document.getElementById('resultsCard');
const boxRisultati = document.getElementById('risultatiBox');
const btnNuovoCalcolo = document.getElementById('nuovoCalcolo');
const selezioneFrequenza = document.getElementById('frequenzaContainer');

let grafico = null;

// Animazione titolo iniziale
window.addEventListener('load', () => {
    const titolo = document.querySelector('#formCard h1');
    if (titolo) titolo.classList.add('h1-show');
});

// Formattazione valuta
function formattaValuta(valore) {
    return valore.toLocaleString('it-IT', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    });
}

// Animazione numeri dei risultati
function animaValori(montanteFinale, interessiTotali, versamentiTotali, datiGrafico, grafico, durata = 2000) {
    const passi = durata / 16;
    let step = 0;

    const intervallo = setInterval(() => {
        step++;
        const progresso = step / passi;

        const elMontante = document.getElementById('montanteTot');
        const elVersTot = document.getElementById('versamentiTot');
        const elInteressi = document.getElementById('interessiMat');

        if (!elMontante) {
            clearInterval(intervallo);
            return;
        }

        elMontante.innerHTML = '€ ' + formattaValuta(montanteFinale * progresso);
        elVersTot.innerHTML = '€ ' + formattaValuta(versamentiTotali * progresso);
        elInteressi.innerHTML = '€ ' + formattaValuta(interessiTotali * progresso);

        if (grafico && grafico.data?.datasets[0]) {
            grafico.data.datasets[0].data = datiGrafico.map(v => v * progresso);
            grafico.update('none');
        }

        if (step >= passi) {
            clearInterval(intervallo);
            elMontante.innerHTML = '€ ' + formattaValuta(montanteFinale);
            elVersTot.innerHTML = '€ ' + formattaValuta(versamentiTotali);
            elInteressi.innerHTML = '€ ' + formattaValuta(interessiTotali);
        }
    }, 16);
}

// Gestione di submit
formCalcolo.addEventListener('submit', function(e) {
    e.preventDefault();

    const dati = new FormData(formCalcolo);

    const versamentoIniziale = parseFloat(dati.get('vers_iniziale'));
    const versamentoPeriodico = parseFloat(dati.get('vers_periodico'));
    const anni = parseFloat(dati.get('anni'));
    const tasso = parseFloat(dati.get('interesse'));
    const tipoInteresse = dati.get('tipo');
    const frequenza = dati.get('frequenza');

    const freqToNum = { annuale: 1, trimestrale: 4, mensile: 12 };
    const periodi = freqToNum[frequenza] || 1;

    const versTotali = versamentoIniziale + versamentoPeriodico * periodi * anni;
    let montanteFinale = 0;
    let interessiTotali = 0;

    //Calcolo locale
    if (tipoInteresse === "semplice") {
        const i = tasso / 100;
        const m = periodi * anni;

        const montIniz = versamentoIniziale * (1 + i * anni);
        const montPer = versamentoPeriodico * m + versamentoPeriodico * i * ((m - 1) / (2 * periodi));

        montanteFinale = montIniz + montPer;
        interessiTotali = montanteFinale - versTotali;

    } else {
        const i = tasso / 100;
        const pot = Math.pow(1 + i / periodi, periodi * anni);

        const montIniz = versamentoIniziale * pot;
        const montPer = versamentoPeriodico * ( (pot - 1) / (i / periodi) );

        montanteFinale = montIniz + montPer;
        interessiTotali = montanteFinale - versTotali;
    }

    // Inserimento dei risultati
    boxRisultati.innerHTML = `
        <p style="text-align:center; font-size:1.2rem; font-weight:600; margin-bottom:5px;">CAPITALE FINALE</p>
        <p id="montanteTot" class="montante-grande">€ 0</p>
        <p><strong>Versamenti totali:</strong> <span id="versamentiTot">€ 0</span></p>
        <p><strong>Interessi maturati:</strong> <span id="interessiMat">€ 0</span></p>
    `;

    // Passaggio da form a risultati
    cardForm.style.opacity = 0;
    cardForm.style.transform = 'scale(0.9)';

    setTimeout(() => {
        cardForm.style.display = 'none';
        cardRisultati.style.display = 'block';
        setTimeout(() => {
            cardRisultati.classList.add('fade-show');
        }, 50);
    }, 400);

    // Grafico andamento
    if (grafico) {
        grafico.destroy();
    }

    const ctx = document.getElementById('graficoRisparmio').getContext('2d');
    const etichette = [];
    const valoriGrafico = [];

    for (let anno = 1; anno <= anni; anno++) {
        let capitale;

        if (tipoInteresse === "semplice") {
            const i = tasso / 100;
            const m = periodi * anno;
            capitale = versamentoIniziale * (1 + i * anno)
                     + versamentoPeriodico * m
                     + versamentoPeriodico * i * ((m - 1) / (2 * periodi));
        } else {
            const i = tasso / 100;
            capitale =
                versamentoIniziale * Math.pow(1 + i / periodi, periodi * anno)
                + versamentoPeriodico * ((Math.pow(1 + i / periodi, periodi * anno) - 1) / (i / periodi || 1));
        }

        etichette.push(`Anno ${anno}`);
        valoriGrafico.push(capitale);
    }

    grafico = new Chart(ctx, {
        type: 'line',
        data: {
            labels: etichette,
            datasets: [{
                label: 'Capitale (€)',
                data: valoriGrafico.map(() => 0),
                fill: true,
                tension: 0.3
            }]
        },
        options: { responsive: true }
    });

    animaValori(montanteFinale, interessiTotali, versTotali, valoriGrafico, grafico);
});

// Reset
btnNuovoCalcolo.addEventListener('click', () => {
    cardRisultati.style.opacity = 0;
    cardRisultati.style.transform = 'scale(0.9)';

    setTimeout(() => {
        cardRisultati.style.display = 'none';
        cardRisultati.classList.remove('fade-show');

        cardForm.style.display = 'block';
        cardForm.style.opacity = 1;
        cardForm.style.transform = 'scale(1)';

        formCalcolo.reset();
    }, 400);
});
</script>
</body>
</html>



